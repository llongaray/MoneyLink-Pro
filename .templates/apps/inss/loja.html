{% extends "base-plus.html" %}
{% load static %}

{% block header_title %}
Visão da Loja - INSS<span class="produto-text"></span>
{% endblock %}

{% block addcss_extra %}
<link rel="stylesheet" href="{% static 'css/apps/inss/loja.css' %}"> {# Reutilizando o CSS de agendamento #}
<link href='https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css' rel='stylesheet'>
{% endblock %}

{% block content %}
<div class="container-fluid my-4">
    <div class="row">
        <!-- COLUNA 1: Ações Rápidas / Registro Cliente Rua -->
        <div class="col-md-4">
            <div class="card mb-4">
                <div class="card-header bg-primary text-white">
                    <i class='bx bx-walk me-2'></i> Registrar Cliente Rua
                </div>
                <div class="card-body">
                    <form id="formClienteRuaInline" method="POST" action="{% url 'inss:all_forms' %}">
                        {% csrf_token %}
                        <input type="hidden" name="form_type" value="cliente_rua">

                        <!-- SEÇÃO: INFORMAÇÕES DO CLIENTE -->
                        <h6 class="section-title"><i class='bx bx-user-detail me-2'></i>Informações do Cliente</h6>
                        <div class="divider mb-2"></div>

                        <div class="mb-2">
                            <label for="nome_cliente_rua_inline" class="form-label">Nome*</label>
                            <input type="text" id="nome_cliente_rua_inline" name="nome_cliente" class="form-control form-control-sm" required maxlength="255">
                        </div>

                        <div class="mb-2">
                            <label for="cpf_cliente_rua_inline" class="form-label">CPF*</label>
                            <input type="text" id="cpf_cliente_rua_inline" name="cpf_cliente" class="form-control form-control-sm" required maxlength="14" placeholder="000.000.000-00">
                        </div>

                        <div class="mb-2">
                            <label for="numero_cliente_rua_inline" class="form-label">Celular*</label>
                            <input type="text" id="numero_cliente_rua_inline" name="numero_cliente" class="form-control form-control-sm" required maxlength="15" placeholder="(00) 0 0000-0000">
                        </div>

                        <div class="mb-2">
                            <label for="data_comparecimento_rua_inline" class="form-label">Data Comparecimento*</label>
                            <input type="date" id="data_comparecimento_rua_inline" name="data_comparecimento" class="form-control form-control-sm" required>
                        </div>

                        <!-- SEÇÃO: INFORMAÇÕES DO ATENDIMENTO -->
                        <h6 class="section-title mt-3"><i class='bx bx-headset me-2'></i>Informações do Atendimento</h6>
                        <div class="divider mb-2"></div>

                        <div class="mb-2">
                            <label for="loja_rua_inline" class="form-label">Loja*</label>
                            <select id="loja_rua_inline" name="loja" class="form-select form-select-sm" required>
                                <option value="">Selecione uma loja</option>
                            </select>
                        </div>

                        <div class="mb-2">
                            <label for="vendedor_rua_inline" class="form-label">Vendedor*</label>
                            <select id="vendedor_rua_inline" name="vendedor_id" class="form-select form-select-sm" required>
                                <option value="">Selecione um vendedor</option>
                            </select>
                        </div>

                        <div class="mb-3"> {# Mais margem antes da tabulação #}
                            <label for="tabulacao_vendedor_rua_inline" class="form-label">Tabulação Vendedor*</label>
                            <select id="tabulacao_vendedor_rua_inline" name="tabulacao_vendedor" class="form-select form-select-sm" required onchange="handleTabulacaoVendedorInline()"> {# JS function a ser criada #}
                                <option value="">Selecione uma opção</option>
                                <option value="NEGOCIO FECHADO">NEGOCIO FECHADO</option>
                                <option value="INELEGIVEL">INELEGIVEL</option>
                                <option value="NÃO ACEITOU">NÃO ACEITOU</option>
                                <option value="NÃO QUIS OUVIR">NÃO QUIS OUVIR</option>
                                <option value="PENDENTE">PENDENTE</option>
                            </select>
                        </div>

                        <!-- Botão para adicionar produtos (inicialmente oculto) -->
                        <div id="addProdutoBtnContainerInline" class="mb-3" style="display: none;">
                             <button type="button" id="btnAddProdutoInline" class="btn btn-secondary btn-sm w-100">
                                <i class='bx bx-plus-circle me-1'></i> Adicionar Produto/Negociação
                            </button>
                        </div>

                        <!-- Container onde os formulários de produto serão adicionados -->
                        <div id="produtosContainerInline">
                            <!-- Produtos adicionados via JS aparecerão aqui -->
                        </div>

                        <!-- Template para um bloco de produto (não será renderizado inicialmente) -->
                        <template id="produtoTemplateInline">
                            <div class="produto-bloco mb-3 p-2 border rounded">
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                     <h6 class="section-title-produto m-0"><i class='bx bx-package me-1'></i>Detalhes do Produto</h6>
                                    <button type="button" class="btn btn-danger btn-sm btn-remove-produto">
                                        <i class='bx bx-trash'></i>
                                    </button>
                                </div>
                                <div class="divider mb-2"></div>

                                <div class="mb-2">
                                    <label for="tipo_negociacao_rua_inline___INDEX__" class="form-label">Tipo Negociação</label>
                                    <select id="tipo_negociacao_rua_inline___INDEX__" name="produtos[__INDEX__][produto_id]" class="form-select form-select-sm">
                                        <option value="">Selecione um produto</option>
                                        <!-- Opções serão preenchidas via JavaScript -->
                                    </select>
                                </div>
                                <div class="mb-2">
                                    <label for="banco_rua_inline___INDEX__" class="form-label">Banco</label>
                                    <input type="text" id="banco_rua_inline___INDEX__" name="produtos[__INDEX__][banco]" class="form-control form-control-sm text-uppercase">
                                </div>
                                <div class="mb-2">
                                    <label for="subsidio_rua_inline___INDEX__" class="form-label">Subsídio</label>
                                    <select id="subsidio_rua_inline___INDEX__" name="produtos[__INDEX__][subsidio]" class="form-select form-select-sm">
                                        <option value="">Selecione</option>
                                        <option value="true">Sim</option>
                                        <option value="false">Não</option>
                                    </select>
                                </div>
                                <div class="mb-2">
                                    <label for="valor_tac_rua_inline___INDEX__" class="form-label">Valor TC</label>
                                    <input type="text" id="valor_tac_rua_inline___INDEX__" name="produtos[__INDEX__][valor_tac]" class="form-control form-control-sm money">
                                </div>
                                <div class="mb-2">
                                    <label for="acao_rua_inline___INDEX__" class="form-label">Com Ação Judicial</label>
                                    <select id="acao_rua_inline___INDEX__" name="produtos[__INDEX__][acao]" class="form-select form-select-sm">
                                        <option value="">Selecione</option>
                                        <option value="true">Sim</option>
                                        <option value="false">Não</option>
                                    </select>
                                </div>
                                <div class="mb-2">
                                    <label for="associacao_rua_inline___INDEX__" class="form-label">Com Associação</label>
                                    <select id="associacao_rua_inline___INDEX__" name="produtos[__INDEX__][associacao]" class="form-select form-select-sm">
                                        <option value="">Selecione</option>
                                        <option value="true">Sim</option>
                                        <option value="false">Não</option>
                                    </select>
                                </div>
                                <div class="mb-2">
                                    <label for="aumento_rua_inline___INDEX__" class="form-label">Com Aumento de Margem</label>
                                    <select id="aumento_rua_inline___INDEX__" name="produtos[__INDEX__][aumento]" class="form-select form-select-sm">
                                        <option value="">Selecione</option>
                                        <option value="true">Sim</option>
                                        <option value="false">Não</option>
                                    </select>
                                </div>
                            </div>
                        </template>

                        <div class="divider mt-3"></div>
                        <button type="submit" class="btn btn-primary w-100 btn-submit">
                            <i class='bx bx-save me-2'></i> Salvar Cliente e Produtos
                        </button>
                    </form>
                    {# Necessário JS para máscaras (CPF, Celular, TAC), lógica condicional e validação #}
                </div>
            </div>
        </div>

        <!-- COLUNA 2: Tabelas de Gerenciamento -->
        <div class="col-md-8">
            <!-- Card Clientes Agendados para Hoje -->
            <div class="card mb-4">
                <div class="card-header" data-bs-toggle="collapse" data-bs-target="#collapseClientesHoje" aria-expanded="true" aria-controls="collapseClientesHoje">
                    <i class='bx bx-calendar-star me-2'></i> Clientes Agendados para Hoje na Loja
                    <i class='bx bx-chevron-down float-end'></i>
                </div>
                <div class="collapse show" id="collapseClientesHoje"> {# Começa expandido (show) #}
                    <div class="card-body">
                        <form id="formFiltroClientesHoje">
                            <div class="filtros-wrapper mb-3">
                                <div class="filtros-container">
                                    <div class="filtro-item">
                                        <input type="text" id="filtroNomeClientesHoje" name="nomeCliente" class="form-control form-control-sm" placeholder="Nome...">
                                    </div>
                                    <div class="filtro-item">
                                        <input type="text" id="filtroCPFClientesHoje" name="cpfCliente" class="form-control form-control-sm" placeholder="CPF...">
                                    </div>
                                    <div class="filtro-item">
                                        <input type="text" id="filtroAtendenteClientesHoje" name="atendente" class="form-control form-control-sm" placeholder="Atendente Agendou...">
                                    </div>
                                    <div class="filtro-item">
                                        <input type="text" id="filtroStatusClientesHoje" name="status" class="form-control form-control-sm" placeholder="Status Agend...">
                                    </div>
                                </div>
                            </div>
                        </form>
                        <div class="table-responsive">
                            <table class="table table-striped table-bordered table-hover" id="tabelaClientesHoje">
                                <thead>
                                    <tr>
                                        <th class="text-center"><i class='bx bx-user me-1'></i>Nome</th>
                                        <th class="text-center"><i class='bx bx-id-card me-1'></i>CPF</th>
                                        <th class="text-center"><i class='bx bx-phone me-1'></i>Número</th>
                                        <th class="text-center"><i class='bx bx-calendar me-1'></i>Dia Agendado</th>
                                        <th class="text-center"><i class='bx bx-user-pin me-1'></i>Atendente Ag.</th>
                                        <th class="text-center"><i class='bx bx-info-circle me-1'></i>Status Agend.</th>
                                        <th class="text-center"><i class='bx bx-store-alt me-1'></i>Loja</th>
                                        <th class="text-center"><i class='bx bx-bolt me-1'></i>Ação</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- Linhas inseridas via JavaScript/API -->
                                </tbody>
                            </table>
                             <div id="nenhumResultadoClientesHoje" class="alert alert-warning text-center" style="display: none;" colspan="8">
                                Nenhum cliente agendado para hoje nesta loja ou com os filtros aplicados.
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Card Agendamentos Pendentes na Loja -->
            <div class="card mb-4 collapsed"> {# Começa fechado #}
                <div class="card-header" data-bs-toggle="collapse" data-bs-target="#collapseAgendamentosPendentes" aria-expanded="false" aria-controls="collapseAgendamentosPendentes">
                    <i class='bx bx-calendar-week me-2'></i> Agendamentos Pendentes na Loja
                    <i class='bx bx-chevron-down float-end'></i>
                </div>
                <div class="collapse" id="collapseAgendamentosPendentes">
                    <div class="card-body">
                        <form id="formFiltroAgendamentosPendentes">
                            <div class="filtros-wrapper mb-3">
                                <div class="filtros-container">
                                    <div class="filtro-item">
                                        <input type="text" id="filtroNomeAgendPendentes" name="nomeCliente" class="form-control form-control-sm" placeholder="Nome...">
                                    </div>
                                    <div class="filtro-item">
                                        <input type="text" id="filtroCPFAgendPendentes" name="cpfCliente" class="form-control form-control-sm" placeholder="CPF...">
                                    </div>
                                    <div class="filtro-item">
                                        <input type="text" id="filtroAtendenteAgendPendentes" name="atendente" class="form-control form-control-sm" placeholder="Atendente Agendou...">
                                    </div>
                                    <div class="filtro-item">
                                        <input type="text" id="filtroStatusAgendPendentes" name="status" class="form-control form-control-sm" placeholder="Status Agend...">
                                    </div>
                                </div>
                            </div>
                        </form>
                        <div class="table-responsive">
                            <table class="table table-striped table-bordered table-hover" id="tabelaAgendamentosPendentes">
                                <thead>
                                    <tr>
                                        <th class="text-center"><i class='bx bx-user me-1'></i>Nome</th>
                                        <th class="text-center"><i class='bx bx-id-card me-1'></i>CPF</th>
                                        <th class="text-center"><i class='bx bx-phone me-1'></i>Número</th>
                                        <th class="text-center"><i class='bx bx-calendar me-1'></i>Dia Agendado</th>
                                        <th class="text-center"><i class='bx bx-user-pin me-1'></i>Atendente Ag.</th>
                                        <th class="text-center"><i class='bx bx-info-circle me-1'></i>Status Agend.</th>
                                        <th class="text-center"><i class='bx bx-store-alt me-1'></i>Loja</th>
                                        <th class="text-center"><i class='bx bx-bolt me-1'></i>Ação</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- Linhas inseridas via JavaScript/API -->
                                </tbody>
                            </table>
                             <div id="nenhumResultadoAgendPendentes" class="alert alert-warning text-center" style="display: none;" colspan="8">
                                Nenhum agendamento pendente nesta loja ou com os filtros aplicados.
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Card Clientes que Não Compareceram na Loja -->
            <div class="card mb-4 collapsed"> {# Começa fechado #}
                <div class="card-header" data-bs-toggle="collapse" data-bs-target="#collapseClientesNaoPresentes" aria-expanded="false" aria-controls="collapseClientesNaoPresentes">
                    <i class='bx bx-calendar-x me-2'></i> Clientes que Não Compareceram na Loja
                    <i class='bx bx-chevron-down float-end'></i>
                </div>
                <div class="collapse" id="collapseClientesNaoPresentes">
                    <div class="card-body">
                        <form id="formFiltroClientesNaoPresentes">
                            <div class="filtros-wrapper mb-3">
                                <div class="filtros-container">
                                    <div class="filtro-item">
                                        <input type="text" id="filtroNomeClientesNaoPresentes" name="nomeCliente" class="form-control form-control-sm" placeholder="Nome...">
                                    </div>
                                    <div class="filtro-item">
                                        <input type="text" id="filtroCPFClientesNaoPresentes" name="cpfCliente" class="form-control form-control-sm" placeholder="CPF...">
                                    </div>
                                    <div class="filtro-item">
                                        <input type="text" id="filtroAtendenteClientesNaoPresentes" name="atendente" class="form-control form-control-sm" placeholder="Atendente Agendou...">
                                    </div>
                                    <div class="filtro-item">
                                        <input type="text" id="filtroStatusClientesNaoPresentes" name="status" class="form-control form-control-sm" placeholder="Status Agend...">
                                    </div>
                                </div>
                            </div>
                        </form>
                        <div class="table-responsive">
                            <table class="table table-striped table-bordered table-hover" id="tabelaClientesNaoPresentes">
                                <thead>
                                    <tr>
                                        <th class="text-center"><i class='bx bx-user me-1'></i>Nome</th>
                                        <th class="text-center"><i class='bx bx-id-card me-1'></i>CPF</th>
                                        <th class="text-center"><i class='bx bx-phone me-1'></i>Número</th>
                                        <th class="text-center"><i class='bx bx-calendar me-1'></i>Dia Agendado</th>
                                        <th class="text-center"><i class='bx bx-user-pin me-1'></i>Atendente Ag.</th>
                                        <th class="text-center"><i class='bx bx-info-circle me-1'></i>Status Agend.</th>
                                        <th class="text-center"><i class='bx bx-store-alt me-1'></i>Loja</th>
                                        <th class="text-center"><i class='bx bx-bolt me-1'></i>Ação</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- Linhas inseridas via JavaScript/API -->
                                </tbody>
                            </table>
                             <div id="nenhumResultadoClientesNaoPresentes" class="alert alert-warning text-center" style="display: none;" colspan="8">
                                Nenhum cliente que não compareceu nesta loja ou com os filtros aplicados.
                            </div>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>
</div>

<!-- ========================================================================== -->
<!--                                  MODAIS                                    -->
<!-- ========================================================================== -->

<!-- SUB MODAL: Cliente Rua -->
<div class="modal-sec" id="modalClienteRua" tabindex="-1" role="dialog" aria-labelledby="modalClienteRuaLabel">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalClienteRuaLabel"><i class='bx bx-walk me-2'></i> Cliente Rua</h5>
                <button type="button" class="btn-close" onclick="fecharModal('#modalClienteRua')" aria-label="Fechar">
                     <i class='bx bx-x'></i>
                </button>
            </div>
            <div class="modal-body">
                 {# Usando form-label e form-control/form-select para consistência #}
                <form id="formClienteRua" method="POST" action="{% url 'inss:all_forms' %}"> {# Action pode precisar de ajuste #}
                    {% csrf_token %}
                    <input type="hidden" name="form_type" value="cliente_rua">

                    <!-- SEÇÃO: INFORMAÇÕES DO CLIENTE -->
                    <h6 class="section-title"><i class='bx bx-user-detail me-2'></i>Informações do Cliente</h6>
                    <div class="divider mb-3"></div>

                    <div class="mb-3">
                        <label for="nome_cliente_rua" class="form-label">Nome do Cliente*</label>
                        <input type="text" id="nome_cliente_rua" name="nome_cliente" class="form-control" required maxlength="255">
                    </div>

                    <div class="mb-3">
                        <label for="cpf_cliente_rua" class="form-label">CPF do Cliente*</label>
                        <input type="text" id="cpf_cliente_rua" name="cpf_cliente" class="form-control" required maxlength="14" placeholder="000.000.000-00">
                    </div>

                    <div class="mb-3">
                        <label for="numero_cliente_rua" class="form-label">Número de Celular*</label>
                        <input type="text" id="numero_cliente_rua" name="numero_cliente" class="form-control" required maxlength="15" placeholder="(00) 0 0000-0000">
                    </div>

                    <div class="mb-3">
                        <label for="data_comparecimento_rua" class="form-label">Data Comparecimento*</label>
                        <input type="date" id="data_comparecimento_rua" name="data_comparecimento" class="form-control" required>
                    </div>

                    <!-- SEÇÃO: INFORMAÇÕES DO ATENDIMENTO -->
                    <h6 class="section-title mt-4"><i class='bx bx-headset me-2'></i>Informações do Atendimento</h6>
                    <div class="divider mb-3"></div>

                    <div class="mb-3">
                        <label for="loja_rua" class="form-label">Loja*</label>
                        <select id="loja_rua" name="loja" class="form-select" required>
                            <option value="">Selecione uma loja</option>
                        </select>
                    </div>

                    <div class="mb-3">
                        <label for="vendedor_rua" class="form-label">Vendedor*</label>
                        <select id="vendedor_rua" name="vendedor_id" class="form-select" required>
                            <option value="">Selecione um vendedor</option>
                        </select>
                    </div>

                    <div class="mb-3">
                        <label for="tabulacao_vendedor_rua" class="form-label">Tabulação Vendedor*</label>
                        <select id="tabulacao_vendedor_rua" name="tabulacao_vendedor" class="form-select" required onchange="handleTabulacaoVendedorRua()">
                            <option value="">Selecione uma opção</option>
                            <option value="NEGOCIO FECHADO">NEGOCIO FECHADO</option>
                            <option value="INELEGIVEL">INELEGIVEL</option>
                            <option value="NÃO ACEITOU">NÃO ACEITOU</option>
                            <option value="NÃO QUIS OUVIR">NÃO QUIS OUVIR</option>
                            <option value="PENDENTE">PENDENTE</option>
                        </select>
                    </div>

                    <!-- SEÇÃO: DETALHES DA NEGOCIAÇÃO (Condicional) -->
                    <div id="fechouNegocioRuaContainer" style="display: none;">
                        <h6 class="section-title mt-4"><i class='bx bx-detail me-2'></i>Detalhes da Negociação</h6>
                        <div class="divider mb-3"></div>

                        <div class="mb-3">
                            <label for="tipo_negociacao_rua" class="form-label">Tipo Negociação</label>
                            <select id="tipo_negociacao_rua" name="produto_id" class="form-select">
                                <option value="">Selecione um produto</option>
                                <!-- Opções serão preenchidas via JavaScript -->
                            </select>
                        </div>

                        <div class="mb-3">
                            <label for="banco_rua" class="form-label">Banco</label>
                            <input type="text" id="banco_rua" name="banco" class="form-control text-uppercase">
                        </div>

                        <div class="mb-3">
                            <label for="subsidio_rua" class="form-label">Subsídio</label>
                            <select id="subsidio_rua" name="subsidio" class="form-select">
                                <option value="">Selecione uma opção</option>
                                <option value="true">Sim</option>
                                <option value="false">Não</option>
                            </select>
                        </div>

                        <div class="mb-3">
                            <label for="valor_tac_rua" class="form-label">Valor TC</label>
                            <input type="text" id="valor_tac_rua" name="valor_tac" class="form-control money"> {# Adicionar máscara JS se necessário #}
                        </div>

                        <div class="mb-3">
                            <label for="acao_rua" class="form-label">Com Ação Judicial</label>
                            <select id="acao_rua" name="acao" class="form-select">
                                <option value="">Selecione uma opção</option>
                                <option value="true">Sim</option>
                                <option value="false">Não</option>
                            </select>
                        </div>

                        <div class="mb-3">
                            <label for="associacao_rua" class="form-label">Com Associação</label>
                            <select id="associacao_rua" name="associacao" class="form-select">
                                <option value="">Selecione uma opção</option>
                                <option value="true">Sim</option>
                                <option value="false">Não</option>
                            </select>
                        </div>

                        <div class="mb-3">
                            <label for="aumento_rua" class="form-label">Com Aumento de Margem</label>
                            <select id="aumento_rua" name="aumento" class="form-select">
                                <option value="">Selecione uma opção</option>
                                <option value="true">Sim</option>
                                <option value="false">Não</option>
                            </select>
                        </div>
                    </div>

                    <!-- SEÇÃO: OBSERVAÇÕES (Removida - Campo não existe mais no modelo PresencaLoja) -->
                    <!--
                    <div id="observacaoVendedorRuaContainer" style="display: none;">
                        <h6 class="section-title mt-4"><i class='bx bx-comment-detail me-2'></i>Observações</h6>
                        <div class="divider mb-3"></div>
                        <div class="mb-3">
                            <label for="observacao_vendedor_rua" class="form-label">Observação do Vendedor*</label>
                            <textarea id="observacao_vendedor_rua" name="observacao_vendedor" class="form-control" rows="3"></textarea>
                        </div>
                    </div>
                    -->

                    <div class="divider mt-4"></div>
                    <button type="submit" class="btn btn-primary w-100 btn-submit">
                        <i class='bx bx-save me-2'></i> Salvar Cliente Rua
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- SUB MODAL: Edição de Cliente/Atendimento (presença) -->
<div class="modal-sec" id="modalEdicaoCliente" tabindex="-1" role="dialog" aria-labelledby="modalEdicaoClienteLabel">
    <div class="modal-dialog" role="document"> {# A classe modal-lg ou modal-xl pode ser adicionada aqui se necessário no CSS/JS #}
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalEdicaoClienteLabel"><i class='bx bx-edit me-2'></i>Detalhes do Atendimento</h5>
                <button type="button" class="btn-close" onclick="fecharModal('#modalEdicaoCliente')" aria-label="Fechar">
                     <i class='bx bx-x'></i>
                </button>
            </div>
            <div class="modal-body">
                <form id="formEdicaoCliente" method="POST" action=""> {# Action será definida via JS #}
                    {% csrf_token %}
                    <input type="hidden" name="form_type" value="edicao_presenca">
                    <input type="hidden" id="presencaIdEdicao" name="presenca_id" value=""> {# ID da PresencaLoja #}
                    <input type="hidden" id="agendamentoIdEdicao" name="agendamento_id" value=""> {# ID do Agendamento associado (se houver) #}

                    <!-- SEÇÃO: Informações do Cliente (Readonly) -->
                    <div class="form-section">
                        <h6 class="form-section-title"><i class='bx bx-user-circle me-2'></i>Informações do Cliente</h6>
                        <div class="form-fields-container"> {# Flex container para os campos #}
                            <div class="form-field third-width">
                                <label for="nomeClienteEdicao" class="form-label">Nome Cliente</label>
                                <input type="text" class="form-control form-control-sm" id="nomeClienteEdicao" name="nome_cliente" readonly>
                            </div>
                            <div class="form-field third-width">
                                <label for="cpfClienteEdicao" class="form-label">CPF</label>
                                <input type="text" class="form-control form-control-sm" id="cpfClienteEdicao" name="cpf_cliente" readonly>
                            </div>
                            <div class="form-field third-width">
                                <label for="numeroClienteEdicao" class="form-label">Número Contato</label>
                                <input type="text" class="form-control form-control-sm" id="numeroClienteEdicao" name="numero_cliente" readonly> {# Adicionar este campo se precisar exibir #}
                            </div>
                        </div>
                    </div>

                    <!-- SEÇÃO: Informações do Agendamento (Readonly) -->
                    <div class="form-section">
                         <h6 class="form-section-title"><i class='bx bx-calendar-check me-2'></i>Informações do Agendamento</h6>
                         <div class="form-fields-container">
                            <div class="form-field third-width">
                                <label for="diaAgendadoEdicao" class="form-label">Dia Agendado</label>
                                <input type="text" class="form-control form-control-sm" id="diaAgendadoEdicao" name="dia_agendado" readonly>
                            </div>
                             <div class="form-field third-width">
                                <label for="lojaAgendadaEdicao" class="form-label">Loja Agendada</label>
                                <input type="text" class="form-control form-control-sm" id="lojaAgendadaEdicao" name="loja_agendada" readonly>
                            </div>
                            <div class="form-field third-width">
                                <label for="atendenteAgendouEdicao" class="form-label">Atendente Agendou</label>
                                <input type="text" class="form-control form-control-sm" id="atendenteAgendouEdicao" name="atendente_agendou" readonly>
                            </div>
                        </div>
                    </div>

                    <!-- SEÇÃO: Atendimento do Vendedor (Editável) -->
                    <div class="form-section">
                        <h6 class="form-section-title"><i class='bx bx-headset me-2'></i>Atendimento do Vendedor</h6>
                        <div class="form-fields-container">
                            <div class="form-field half-width">
                                <label for="vendedorLojaEdicao" class="form-label">Vendedor*</label>
                                <select class="form-select form-select-sm" id="vendedorLojaEdicao" name="vendedor_id" required>
                                    <option value="">Selecione um vendedor</option>
                                    {# Opções carregadas via JS #}
                                </select>
                            </div>
                            <div class="form-field half-width">
                                <label for="tabulacaoVendedorEdicao" class="form-label">Tabulação Vendedor*</label>
                                <select class="form-select form-select-sm" id="tabulacaoVendedorEdicao" name="tabulacao_vendedor" required>
                                    <option value="">Selecione uma opção</option>
                                    <option value="NEGOCIO FECHADO">NEGOCIO FECHADO</option>
                                    <option value="INELEGIVEL">INELEGIVEL</option>
                                    <option value="NÃO ACEITOU">NÃO ACEITOU</option>
                                    <option value="NÃO QUIS OUVIR">NÃO QUIS OUVIR</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- Container para os campos específicos de FECHOU NEGOCIO -->
                    <div id="fechouNegocioContainerEdicao" style="display: none;" class="form-section">
                        <h6 class="form-section-title"><i class='bx bx-detail me-2'></i>Detalhes da Negociação / Produtos</h6>
                        <div class="divider mb-3 w-100"></div>

                        <!-- Botão para adicionar produtos -->
                        <div id="addProdutoBtnContainerEdicao" class="mb-3 w-100 text-center"> {# Centralizado ou alinhado como preferir #}
                            <button type="button" id="btnAddProdutoEdicao" class="btn btn-secondary btn-sm">
                                <i class='bx bx-plus-circle me-1'></i> Adicionar Produto/Negociação
                            </button>
                        </div>

                        <!-- Container onde os formulários de produto serão adicionados -->
                        <div id="produtosContainerEdicao" class="produtos-container">
                            <!-- Produtos adicionados via JS aparecerão aqui usando o template -->
                        </div>
                    </div>

                     <!-- Template para um bloco de produto (será clonado via JS) -->
                    <template id="produtoTemplateEdicao">
                        <div class="produto-bloco"> {# A classe define flex-basis e min-width no CSS #}
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <h6 class="section-title-produto m-0"><i class='bx bx-package me-1'></i>Detalhes do Produto</h6>
                                <button type="button" class="btn btn-danger btn-sm btn-remove-produto" aria-label="Remover Produto">
                                    <i class='bx bx-trash'></i>
                                </button>
                            </div>
                            <div class="divider mb-3"></div>

                            {# Campos do produto organizados com flex-wrap implícito pelo container pai #}
                            <div class="form-field mb-2">
                                <label for="tipo_negociacao_edicao___INDEX__" class="form-label">Tipo Negociação</label>
                                <select id="tipo_negociacao_edicao___INDEX__" name="produtos[__INDEX__][produto_id]" class="form-select form-select-sm">
                                    <option value="">Selecione um produto</option>
                                    <!-- Opções serão preenchidas via JavaScript -->
                                </select>
                            </div>
                            <div class="form-field mb-2">
                                <label for="banco_edicao___INDEX__" class="form-label">Banco</label>
                                <input type="text" id="banco_edicao___INDEX__" name="produtos[__INDEX__][banco]" class="form-control form-control-sm text-uppercase">
                            </div>
                            <div class="form-field mb-2">
                                <label for="valor_tac_edicao___INDEX__" class="form-label">Valor TAC</label>
                                <input type="text" id="valor_tac_edicao___INDEX__" name="produtos[__INDEX__][valor_tac]" class="form-control form-control-sm money">
                            </div>
                            {# Usando form-field-inline-group para colocar selects menores lado a lado se couber #}
                            <div class="form-field-inline-group mb-2">
                                <div class="form-field">
                                    <label for="subsidio_edicao___INDEX__" class="form-label">Subsídio</label>
                                    <select id="subsidio_edicao___INDEX__" name="produtos[__INDEX__][subsidio]" class="form-select form-select-sm">
                                        <option value="">Selecione</option>
                                        <option value="true">Sim</option>
                                        <option value="false">Não</option>
                                    </select>
                                </div>
                                <div class="form-field">
                                    <label for="acao_edicao___INDEX__" class="form-label">Ação Judicial</label>
                                    <select id="acao_edicao___INDEX__" name="produtos[__INDEX__][acao]" class="form-select form-select-sm">
                                        <option value="">Selecione</option>
                                        <option value="true">Sim</option>
                                        <option value="false">Não</option>
                                    </select>
                                </div>
                            </div>
                             <div class="form-field-inline-group mb-2">
                                <div class="form-field">
                                    <label for="associacao_edicao___INDEX__" class="form-label">Associação</label>
                                    <select id="associacao_edicao___INDEX__" name="produtos[__INDEX__][associacao]" class="form-select form-select-sm">
                                        <option value="">Selecione</option>
                                        <option value="true">Sim</option>
                                        <option value="false">Não</option>
                                    </select>
                                </div>
                                <div class="form-field">
                                    <label for="aumento_edicao___INDEX__" class="form-label">Aumento Margem</label>
                                    <select id="aumento_edicao___INDEX__" name="produtos[__INDEX__][aumento]" class="form-select form-select-sm">
                                        <option value="">Selecione</option>
                                        <option value="true">Sim</option>
                                        <option value="false">Não</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </template>

                    <div class="divider mt-4 w-100"></div>
                    <button type="submit" class="btn btn-primary w-100 btn-submit">
                        <i class='bx bx-save me-2'></i> Salvar Alterações Atendimento
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block addjs_extra %}
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
{# Se você tiver um arquivo JS específico para esta página: #}
<script src="{% static 'js/apps/inss/loja.js' %}"></script> {# Criar ou adaptar este JS #}
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.mask/1.14.16/jquery.mask.min.js"></script>
{% endblock %}
